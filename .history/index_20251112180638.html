<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ESP32 → Flespi → Web</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <main class="container">
    <header class="head">
      <h1>ESP32 → Flespi → Web</h1>
      <div id="status" class="badge warn">Conectando…</div>
    </header>

    <section class="meta">
      <div><b>Topic:</b> <code id="topicLbl"></code></div>
      <div><b>Mensajes:</b> <span id="count">0</span></div>
      <div><b>Último:</b> <span id="ago">esperando…</span></div>
    </section>

    <section class="card">
      <h2>Campos (automático)</h2>
      <div id="kv" class="kv">Esperando…</div>
    </section>

    <section class="card">
      <h2>Payload crudo</h2>
      <pre id="raw" class="pre">Esperando datos…</pre>
      <small>Publica con <b>retain</b> desde MQTT Board y aparecerá al cargar.</small>
    </section>
  </main>

<script>
const TOPIC = "esp32/test";
document.getElementById("topicLbl").textContent = TOPIC;

const $ = id => document.getElementById(id);
const setBadge = (cls, txt) => { const el = $("status"); el.className = "badge " + cls; el.textContent = txt; };

let token = new URLSearchParams(location.search).get("token") || "";
if (!token) token = prompt("Pega tu token Flespi (Allowed origins = ANY):", "") || "";
if (!token) { setBadge("err", "Sin token"); throw new Error("No token"); }

let last = null, n = 0;
setInterval(()=>{ $("ago").textContent = last ? `hace ${Math.floor((Date.now()-last)/1000)}s` : "esperando…"; }, 1000);

function renderKV(obj){
  const cont = $("kv");
  const ks = Object.keys(obj);
  if (!ks.length){ cont.textContent = "(sin campos)"; return; }
  let html = '<table class="table"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody>';
  ks.sort().forEach(k=>{
    let v = obj[k];
    if (typeof v === "object" && v !== null) v = JSON.stringify(v);
    if (v === "" || v === null || v === undefined) v = "—";
    html += `<tr><td>${k}</td><td>${String(v)}</td></tr>`;
  });
  html += '</tbody></table>';
  cont.innerHTML = html;
}

const client = mqtt.connect("wss://mqtt.flespi.io/mqtt", {
  clientId: "web-"+Math.random().toString(16).slice(2),
  username: "FlespiToken",
  password: token,
  clean: true,
  reconnectPeriod: 2000
});

client.on("connect", () => {
  setBadge("ok", "Conexión exitosa");
  client.subscribe(TOPIC, err => { if (err) setBadge("err", "Error suscribiendo: "+err.message); });
});

client.on("reconnect", () => setBadge("warn", "Reconectando…"));
client.on("close",     () => setBadge("err", "Desconectado"));
client.on("error",     e  => setBadge("err", "Conexión errónea: " + (e?.message || e)));

client.on("message", (_t, payload) => {
  n++; $("count").textContent = n;
  last = Date.now();
  const txt = payload.toString();
  $("raw").textContent = txt;
  try {
    const data = JSON.parse(txt);
    renderKV(data);
    $("raw").textContent = JSON.stringify(data, null, 2);
  } catch {
    $("kv").textContent = "(payload no es JSON)";
  }
});
</script>
</body>
</html>
