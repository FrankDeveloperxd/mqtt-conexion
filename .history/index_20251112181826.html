<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 ‚Üí Flespi ‚Üí Web</title>
  <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 15px;
    }
    
    .status-bar {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .badge::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .badge.conectando {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge.conectando::before {
      background: #f59e0b;
      animation: pulse 1.5s infinite;
    }
    
    .badge.conectado {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge.conectado::before {
      background: #10b981;
    }
    
    .badge.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge.error::before {
      background: #ef4444;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .info {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      font-size: 14px;
      color: #666;
    }
    
    .info-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .info-item strong {
      color: #333;
    }
    
    code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      color: #7c3aed;
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      color: #333;
      font-size: 20px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .data-table th {
      background: #f9fafb;
      color: #666;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
    }
    
    .data-table td {
      color: #333;
      font-family: 'Courier New', monospace;
    }
    
    .data-table tbody tr:hover {
      background: #f9fafb;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 10px;
      opacity: 0.3;
    }
    
    pre {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .tip {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 12px 15px;
      margin-top: 15px;
      border-radius: 4px;
      font-size: 13px;
      color: #1e40af;
    }
    
    @media (max-width: 600px) {
      .status-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì° Monitor ESP32 ‚Üí Flespi</h1>
      <div class="status-bar">
        <div id="status" class="badge conectando">Conectando...</div>
        <div class="info">
          <div class="info-item">
            <strong>Topic:</strong> <code id="topicDisplay">esp32/test</code>
          </div>
          <div class="info-item">
            <strong>Mensajes:</strong> <span id="msgCount">0</span>
          </div>
          <div class="info-item">
            <strong>√öltimo:</strong> <span id="lastTime">esperando...</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üìä Datos Recibidos</h2>
      <div id="dataContainer">
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p>Esperando datos del ESP32...</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üìÑ Payload Crudo (JSON)</h2>
      <pre id="rawPayload">Esperando datos...</pre>
      <div class="tip">
        üí° <strong>Tip:</strong> Publica mensajes con <strong>retain</strong> desde MQTT Board para que aparezcan inmediatamente al cargar la p√°gina.
      </div>
    </div>
  </div>

  <script>
    const TOPIC = 'esp32/test';
    const BROKER = 'wss://mqtt.flespi.io/mqtt';
    
    // Obtener token de la URL (?token=TU_TOKEN)
    const urlParams = new URLSearchParams(window.location.search);
    let TOKEN = urlParams.get('token');
    
    // Si no hay token en URL, pedirlo
    if (!TOKEN) {
      TOKEN = prompt('Ingresa tu token de Flespi:', '');
      if (!TOKEN) {
        alert('‚ùå Token requerido para conectar');
        throw new Error('No token provided');
      }
    }
    
    // Referencias DOM
    const statusEl = document.getElementById('status');
    const msgCountEl = document.getElementById('msgCount');
    const lastTimeEl = document.getElementById('lastTime');
    const dataContainerEl = document.getElementById('dataContainer');
    const rawPayloadEl = document.getElementById('rawPayload');
    
    let messageCount = 0;
    let lastMessageTime = null;
    
    // Actualizar estado de conexi√≥n
    function setStatus(type, message) {
      statusEl.className = `badge ${type}`;
      statusEl.textContent = message;
    }
    
    // Actualizar tiempo transcurrido
    setInterval(() => {
      if (lastMessageTime) {
        const seconds = Math.floor((Date.now() - lastMessageTime) / 1000);
        lastTimeEl.textContent = `hace ${seconds}s`;
      }
    }, 1000);
    
    // Renderizar datos en tabla
    function renderData(data) {
      const keys = Object.keys(data);
      
      if (keys.length === 0) {
        dataContainerEl.innerHTML = '<div class="empty-state"><p>Payload vac√≠o</p></div>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody>';
      
      keys.sort().forEach(key => {
        let value = data[key];
        
        // Formatear valor
        if (value === null || value === undefined) {
          value = '<em style="color: #999;">null</em>';
        } else if (typeof value === 'object') {
          value = JSON.stringify(value);
        } else {
          value = String(value);
        }
        
        html += `<tr><td><strong>${key}</strong></td><td>${value}</td></tr>`;
      });
      
      html += '</tbody></table>';
      dataContainerEl.innerHTML = html;
    }
    
    // Conectar a MQTT
    console.log('üîå Conectando a Flespi...');
    console.log('Broker:', BROKER);
    console.log('Topic:', TOPIC);
    
    const client = mqtt.connect(BROKER, {
      clientId: 'web-monitor-' + Math.random().toString(16).substr(2, 8),
      username: 'FlespiToken ' + TOKEN,  // ‚ö†Ô∏è CR√çTICO: Token va en username
      password: '',  // ‚ö†Ô∏è CR√çTICO: Password vac√≠o
      clean: true,
      reconnectPeriod: 3000,
      connectTimeout: 10000
    });
    
    // Eventos de conexi√≥n
    client.on('connect', () => {
      console.log('‚úÖ Conectado a Flespi');
      setStatus('conectado', '‚úÖ Conectado');
      
      client.subscribe(TOPIC, { qos: 0 }, (err) => {
        if (err) {
          console.error('‚ùå Error al suscribirse:', err);
          setStatus('error', '‚ùå Error en suscripci√≥n');
        } else {
          console.log('üì° Suscrito a:', TOPIC);
        }
      });
    });
    
    client.on('reconnect', () => {
      console.log('üîÑ Reconectando...');
      setStatus('conectando', 'üîÑ Reconectando...');
    });
    
    client.on('close', () => {
      console.log('‚ö†Ô∏è Conexi√≥n cerrada');
      setStatus('error', '‚ö†Ô∏è Desconectado');
    });
    
    client.on('error', (error) => {
      console.error('‚ùå Error MQTT:', error);
      const errorMsg = error.message || error.toString();
      setStatus('error', '‚ùå Error: ' + errorMsg);
      
      // Mensajes de ayuda
      if (errorMsg.includes('Bad username or password')) {
        console.error('üîë Verifica que el token sea correcto y est√© habilitado en Flespi');
      }
    });
    
    // Recibir mensajes
    client.on('message', (topic, payload) => {
      console.log('üì® Mensaje recibido en', topic);
      
      messageCount++;
      lastMessageTime = Date.now();
      msgCountEl.textContent = messageCount;
      
      const payloadStr = payload.toString();
      console.log('Payload:', payloadStr);
      
      // Mostrar payload crudo
      try {
        const data = JSON.parse(payloadStr);
        rawPayloadEl.textContent = JSON.stringify(data, null, 2);
        renderData(data);
      } catch (e) {
        // No es JSON v√°lido
        rawPayloadEl.textContent = payloadStr;
        dataContainerEl.innerHTML = '<div class="empty-state"><p>‚ö†Ô∏è El payload no es JSON v√°lido</p></div>';
      }
    });
    
    console.log('‚è≥ Esperando conexi√≥n...');
  </script>
</body>
</html>